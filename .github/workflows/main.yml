name: Linux Build & AppImage

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  BINARY_NAME: pair
  RECIPE: AppImageBuilder.yml

jobs:
  build-appimage:
    name: Build & Package AppImage
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout source
      - uses: actions/checkout@v3

      # 2) Set up Rust and build release binary
      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable

      - name: Build release binary
        run: cargo build --release --bin ${{ env.BINARY_NAME }}

      # 3) Stage AppDir
      - name: Prepare AppDir
        run: |
          # create AppDir hierarchy
          mkdir -p AppDir/usr/bin \
                   AppDir/usr/share/applications \
                   AppDir/usr/share/icons/hicolor/256x256/apps

          # copy binary
          cp target/release/${{ env.BINARY_NAME }} AppDir/usr/bin/

          # generate desktop file
          cat > AppDir/usr/share/applications/${{ env.BINARY_NAME }}.desktop <<EOF
          [Desktop Entry]
          Type=Application
          Name=Pair
          Exec=${{ env.BINARY_NAME }}
          Icon=idevicepair
          Categories=Utility;
          Terminal=false
          EOF

          # copy icon
          cp icons/idevicepair.png \
             AppDir/usr/share/icons/hicolor/256x256/apps/idevicepair.png

      # 4) (Optional) Install extra deps for recipe
      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse2

      # 5) Build .AppImage using the official action
      - name: Build AppImage
        uses: AppImageCrafters/build-appimage-action@master
        with:
          recipe: ${{ env.RECIPE }}
        env:
          # enable auto‐update metadata via GitHub Releases
          UPDATE_INFO: gh-releases-zsync|${{ github.repository_owner }}|${{ github.event.repository.name }}|latest|*.AppImage.zsync

      # 6) Upload artifacts
      - name: Upload AppImage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: AppImage
          path: |
            *.AppImage
            *.AppImage.zsync
