name: CI

on:
  push:
    branches: [ main ]

jobs:
  build-all:
    runs-on: macos-latest
    env:
      PACKAGE_NAME: idevicepair

    steps:
      - uses: actions/checkout@v3

      - name: Uninstall Homebrewâ€™s rustup
        run: brew uninstall rustup rustup-init || true

      - name: Install Rust & add targets
        run: |
          curl https://sh.rustup.rs -sSf | sh -s -- -y --default-toolchain stable
          source $HOME/.cargo/env
          rustup component add rustfmt clippy
          rustup target add \
            x86_64-unknown-linux-gnu \
            aarch64-unknown-linux-gnu \
            x86_64-apple-darwin \
            aarch64-apple-darwin \
            x86_64-pc-windows-gnu

      - name: Install Zig & mingw-w64
        run: |
          brew install zig
          brew install mingw-w64

      - name: Install cargo-zigbuild
        run: cargo install cargo-zigbuild

      # Linux static via Zig
      - name: Build Linux x86_64
        run: cargo zigbuild --release --package $PACKAGE_NAME --target x86_64-unknown-linux-gnu

      - name: Build Linux ARM64
        run: cargo zigbuild --release --package $PACKAGE_NAME --target aarch64-unknown-linux-gnu

      # macOS native
      - name: Build macOS x86_64
        run: cargo build --release --package $PACKAGE_NAME --target x86_64-apple-darwin

      - name: Build macOS ARM64
        run: cargo build --release --package $PACKAGE_NAME --target aarch64-apple-darwin

      - name: Create macOS Universal
        run: |
          mkdir -p target/universal/release
          lipo \
            target/x86_64-apple-darwin/release/$PACKAGE_NAME \
            target/aarch64-apple-darwin/release/$PACKAGE_NAME \
            -create -output target/universal/release/$PACKAGE_NAME

      # Windows GNU cross-compile
      - name: Build Windows x86_64-pc-windows-gnu
        run: cargo build --release --package $PACKAGE_NAME --target x86_64-pc-windows-gnu

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: all-binaries
          path: |
            target/x86_64-unknown-linux-gnu/release/$PACKAGE_NAME
            target/aarch64-unknown-linux-gnu/release/$PACKAGE_NAME
            target/universal/release/$PACKAGE_NAME
            target/x86_64-pc-windows-gnu/release/$PACKAGE_NAME.exe
