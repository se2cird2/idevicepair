name: CI

on:
  push:
    branches: [ main ]

env:
  BINARY_NAME: pair

jobs:
  # ───────────────────────────────────────────────────────────────────────────
  # 1) Linux on Ubuntu — build natively with cargo
  build-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target: [ x86_64-unknown-linux-gnu, aarch64-unknown-linux-gnu ]

    steps:
      - uses: actions/checkout@v3

      - name: Install Rust & add target
        run: |
          curl https://sh.rustup.rs -sSf | sh -s -- -y
          source $HOME/.cargo/env
          rustup component add rustfmt clippy
          rustup target add ${{ matrix.target }}

      - name: Build Linux ${{ matrix.target }}
        run: |
          cargo build --release --bin pair --target ${{ matrix.target }}

      - name: Upload Linux ${{ matrix.target }}
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.target }}
          path: target/${{ matrix.target }}/release/pair

  # ───────────────────────────────────────────────────────────────────────────
  # 2) macOS on macos-latest — native slices + universal
  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        target: [ x86_64-apple-darwin, aarch64-apple-darwin ]

    steps:
      - uses: actions/checkout@v3

      - name: Uninstall Homebrew rustup
        run: brew uninstall rustup rustup-init || true

      - name: Install Rust & add target
        run: |
          curl https://sh.rustup.rs -sSf | sh -s -- -y
          source $HOME/.cargo/env
          rustup component add rustfmt clippy
          rustup target add ${{ matrix.target }}

      - name: Build macOS ${{ matrix.target }}
        run: cargo build --release --bin pair --target ${{ matrix.target }}

      - name: Upload macOS ${{ matrix.target }}
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.target }}
          path: target/${{ matrix.target }}/release/pair

  universal-macos:
    needs: build-macos
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3

      - name: Create universal binary
        run: |
          mkdir -p target/universal/release
          lipo \
            target/x86_64-apple-darwin/release/pair \
            target/aarch64-apple-darwin/release/pair \
            -create -output target/universal/release/pair

      - name: Upload macOS universal
        uses: actions/upload-artifact@v4
        with:
          name: macos-universal
          path: target/universal/release/pair

  # ───────────────────────────────────────────────────────────────────────────
  # 3) Windows on windows-latest — native with mingw
  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        target: [ x86_64-pc-windows-gnu ]

    steps:
      - uses: actions/checkout@v3

      - name: Install Rust & add target
        run: |
          curl https://sh.rustup.rs -sSf | sh -s -- -y
          refreshenv
          rustup component add rustfmt clippy
          rustup target add ${{ matrix.target }}

      - name: Install mingw-w64
        run: choco install mingw -y

      - name: Build Windows ${{ matrix.target }}
        run: cargo build --release --bin pair --target ${{ matrix.target }}

      - name: Upload Windows
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ matrix.target }}
          path: target/${{ matrix.target }}/release/pair.exe
